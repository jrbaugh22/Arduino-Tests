#include <Servo.h>
#include <Stepper.h>

const int stepsPerRevolution = 2048;  // For 28BYJ-48 (geared)
Stepper myStepper(stepsPerRevolution, 5, 6, 7, 8);  // IN1 to IN4

Servo myServo;

int clkPin = 2;
int dtPin = 3;
int lastClkState;
long encoderPos = 0;  // Long for many turns

void setup() {
  pinMode(clkPin, INPUT);
  pinMode(dtPin, INPUT);
  
  myStepper.setSpeed(10);  // RPM (adjust 5-15 for smoothness)
  myServo.attach(9);
  myServo.write(90);  // Center start
  
  Serial.begin(9600);
  lastClkState = digitalRead(clkPin);
}

void loop() {
  int clkState = digitalRead(clkPin);
  if (clkState != lastClkState) {
    if (digitalRead(dtPin) != clkState) {
      encoderPos += 32;  // Larger steps for visible stepper movement
    } else {
      encoderPos -= 32;
    }
    
    // Step the stepper motor (accumulates for full rotations)
    myStepper.step((encoderPos > 0 ? 32 : -32));  // Match direction
    
    // Map position to servo angle (repeats every ~1800 for 0-180 sweep)
    int servoAngle = map((encoderPos % 1800 + 1800) % 1800, 0, 1799, 0, 180);
    myServo.write(servoAngle);
    
    Serial.print("Encoder Pos: ");
    Serial.print(encoderPos);
    Serial.print(" | Servo Angle: ");
    Serial.println(servoAngle);
  }
  lastClkState = clkState;
}

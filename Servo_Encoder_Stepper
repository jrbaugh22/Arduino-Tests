#include <Servo.h>
#include <Stepper.h>

const int stepsPerRevolution = 2048;                // For 28BYJ-48 with ULN2003
Stepper myStepper(stepsPerRevolution, 5, 7, 6, 8);   // IN1, IN3, IN2, IN4 (smooth direction order)

Servo myServo;

const int clkPin = 2;       // Rotary encoder CLK
const int dtPin  = 3;       // Rotary encoder DT
int lastClkState;
long encoderPos = 0;

unsigned long lastDebounceTime = 0;
const unsigned long debounceDelay = 1;  // milliseconds (1-3 works well)

void setup() {
  pinMode(clkPin, INPUT);
  pinMode(dtPin,  INPUT);
  
  myStepper.setSpeed(15);   // Max reliable speed for dramatic movement (reduce if it skips)
  myServo.attach(9);        // Servo signal on pin 9
  myServo.write(90);        // Start servo in middle position
  
  Serial.begin(9600);
  lastClkState = digitalRead(clkPin);
}

void loop() {
  int clkState = digitalRead(clkPin);
  
  // Only act on CLK change and after debounce period
  if (clkState != lastClkState && millis() - lastDebounceTime > debounceDelay) {
    int dtState = digitalRead(dtPin);
    
    const int stepAmount = 128;   // Dramatic movement per encoder detent (try 64, 128, 256)
    
    if (clkState == dtState) {
      // Clockwise
      encoderPos += stepAmount;
      myStepper.step(stepAmount);
    } else {
      // Counter-clockwise
      encoderPos -= stepAmount;
      myStepper.step(-stepAmount);
    }
    
    // Servo sweeps repeatedly between 0° and 180°
    int servoAngle = map((encoderPos % 1800 + 1800) % 1800, 0, 1799, 0, 180);
    myServo.write(servoAngle);
    
    // Debug output
    Serial.print("Pos: ");
    Serial.print(encoderPos);
    Serial.print(" | Servo: ");
    Serial.println(servoAngle);
    
    lastDebounceTime = millis();  // Reset debounce timer
  }
  
  lastClkState = clkState;
}
